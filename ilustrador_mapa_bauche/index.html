<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Planos</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- ==================== VISTA PROYECTOS ==================== -->
    <div id="projects-view">
        <header class="projects-header">
            <h1>Editor de Planos</h1>
            <button id="btn-crear-proyecto" class="btn btn-primary">+ Crear Proyecto</button>
        </header>

        <div id="projects-grid" class="projects-grid">
            <!-- Los proyectos se cargan dinamicamente -->
        </div>

        <div id="projects-empty" class="projects-empty">
            <p>No hay proyectos creados</p>
            <p class="hint">Crea un nuevo proyecto para comenzar a editar un plano</p>
        </div>
    </div>

    <!-- Modal Crear Proyecto -->
    <div id="modal-crear-proyecto" class="modal hidden">
        <div class="modal-content">
            <h2>Crear Nuevo Proyecto</h2>
            <form id="form-crear-proyecto">
                <div class="form-group">
                    <label for="proyecto-nombre">Nombre del Proyecto *</label>
                    <input type="text" id="proyecto-nombre" required placeholder="Ej: Plano San Rafael">
                </div>
                <div class="form-group">
                    <label for="proyecto-imagen">Imagen del Plano *</label>
                    <input type="file" id="proyecto-imagen" accept="image/*" required>
                    <p class="hint">Selecciona la imagen del plano que deseas editar</p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" id="btn-cancelar-proyecto">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear Proyecto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==================== VISTA EDITOR ==================== -->
    <div id="editor-view" class="hidden">
        <div id="app">
            <!-- Barra superior -->
            <header id="toolbar">
                <div class="toolbar-left">
                    <button id="btn-volver" class="btn btn-back" title="Volver a proyectos">&larr; Proyectos</button>
                    <h1 id="editor-titulo" title="Click para renombrar">Editor</h1>
                </div>
                <div class="toolbar-actions">
                    <button id="btn-deshacer" class="btn" title="Deshacer (Ctrl+Z)">&#8630; Deshacer</button>
                    <button id="btn-guardar" class="btn btn-primary">Guardar</button>
                    <div class="dropdown">
                        <button class="btn">Exportar</button>
                        <div class="dropdown-content">
                            <a href="#" id="btn-exportar-png">Exportar PNG</a>
                            <a href="#" id="btn-exportar-excel">Exportar Lotes Excel</a>
                            <a href="#" id="btn-exportar-db">Exportar Base de Datos</a>
                            <a href="#" id="btn-imprimir">Imprimir</a>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn">Importar</button>
                        <div class="dropdown-content">
                            <label for="input-imagen" class="dropdown-item">Cambiar Imagen</label>
                            <input type="file" id="input-imagen" accept="image/*" hidden>
                            <label for="input-db" class="dropdown-item">Cargar Base de Datos</label>
                            <input type="file" id="input-db" accept=".sqlite,.db" hidden>
                        </div>
                    </div>
                    <button id="btn-compartir" class="btn" title="Compartir proyecto">&#128279; Compartir</button>
                </div>
            </header>

            <!-- Contenedor principal -->
            <div id="main-container">
                <!-- Panel izquierdo - Herramientas -->
                <aside id="panel-izquierdo">
                    <div class="panel-section">
                        <h3>Herramientas</h3>
                        <div class="tool-buttons">
                            <button id="tool-select" class="tool-btn active" title="Seleccionar (V)">
                                <span class="icon">&#9995;</span>
                                <span class="label">Seleccionar</span>
                            </button>
                            <button id="tool-text" class="tool-btn" title="Agregar Texto (T)">
                                <span class="icon">T</span>
                                <span class="label">Texto</span>
                            </button>
                            <button id="tool-polygon" class="tool-btn" title="Dibujar Poligono (P)">
                                <span class="icon">&#11039;</span>
                                <span class="label">Poligono</span>
                            </button>
                            <button id="tool-line" class="tool-btn" title="Dibujar Linea (L)">
                                <span class="icon">&#9585;</span>
                                <span class="label">Linea</span>
                            </button>
                            <button id="tool-pan" class="tool-btn" title="Mover vista (Espacio)">
                                <span class="icon">&#9995;</span>
                                <span class="label">Mover</span>
                            </button>
                        </div>
                        <div class="zoom-controls">
                            <button id="zoom-out" class="btn-small">-</button>
                            <span id="zoom-level">100%</span>
                            <button id="zoom-in" class="btn-small">+</button>
                            <button id="zoom-fit" class="btn-small" title="Ajustar a ventana">Ajustar</button>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h3>Lotes</h3>
                        <div class="search-box">
                            <input type="text" id="buscar-lote" placeholder="Buscar lote...">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">Todos</button>
                            <button class="filter-btn" data-filter="oficial">Oficiales</button>
                            <button class="filter-btn" data-filter="agregado">Agregados</button>
                        </div>
                        <ul id="lista-lotes" class="lotes-list">
                            <li class="lote-item empty">No hay lotes registrados</li>
                        </ul>
                    </div>
                </aside>

                <!-- Canvas principal -->
                <main id="canvas-container">
                    <canvas id="canvas-principal"></canvas>
                </main>

                <!-- Panel derecho - Propiedades -->
                <aside id="panel-derecho">
                    <div class="panel-section">
                        <h3>Propiedades</h3>
                        <div id="propiedades-vacio">
                            <p class="hint">Selecciona un lote para ver sus propiedades</p>
                        </div>
                        <form id="form-propiedades" class="hidden">
                            <div class="form-group">
                                <label for="prop-nombre">Nombre Propietario</label>
                                <input type="text" id="prop-nombre" placeholder="Nombre del propietario">
                            </div>
                            <div class="form-group">
                                <label for="prop-rol">Numero de Rol</label>
                                <input type="text" id="prop-rol" placeholder="Ej: 123-456">
                            </div>
                            <div class="form-group">
                                <label for="prop-telefono">Telefono</label>
                                <input type="text" id="prop-telefono" placeholder="Ej: +56912345678">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Lote</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="prop-tipo" value="1" checked>
                                        <span class="tipo-oficial">Oficial</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="prop-tipo" value="0">
                                        <span class="tipo-agregado">Agregado</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="prop-notas">Notas</label>
                                <textarea id="prop-notas" rows="3" placeholder="Observaciones..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                <button type="button" id="btn-eliminar-lote" class="btn btn-danger">Eliminar</button>
                            </div>
                        </form>
                    </div>

                    <div class="panel-section">
                        <h3>Nuevo Lote</h3>
                        <button id="btn-nuevo-lote" class="btn btn-block">+ Crear Lote</button>
                        <button id="btn-cargar-iniciales" class="btn btn-block" style="margin-top:8px;font-size:12px;">Cargar 53 clientes (San Rafael)</button>
                    </div>
                </aside>
            </div>

            <!-- Barra de estado -->
            <footer id="status-bar">
                <span id="status-lotes">0 lotes</span>
                <span id="status-zoom">Zoom: 100%</span>
                <span id="status-pos">x: 0, y: 0</span>
                <span id="status-modo">Modo: Seleccionar</span>
            </footer>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip">
        <div class="tooltip-content"></div>
    </div>

    <!-- Modal para crear nuevo lote -->
    <div id="modal-nuevo-lote" class="modal hidden">
        <div class="modal-content">
            <h2>Crear Nuevo Lote</h2>
            <form id="form-nuevo-lote">
                <div class="form-group">
                    <label for="nuevo-nombre">Nombre Propietario *</label>
                    <input type="text" id="nuevo-nombre" required>
                </div>
                <div class="form-group">
                    <label for="nuevo-rol">Numero de Rol</label>
                    <input type="text" id="nuevo-rol">
                </div>
                <div class="form-group">
                    <label for="nuevo-telefono">Telefono</label>
                    <input type="text" id="nuevo-telefono" placeholder="+56...">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="nuevo-tipo" value="1" checked>
                            <span class="tipo-oficial">Oficial</span>
                        </label>
                        <label>
                            <input type="radio" name="nuevo-tipo" value="0">
                            <span class="tipo-agregado">Agregado Manualmente</span>
                        </label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" id="btn-cancelar-lote">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear y Agregar Texto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Compartir Proyecto -->
    <div id="modal-compartir" class="modal hidden">
        <div class="modal-content">
            <h2>Compartir Proyecto</h2>
            <p style="margin-bottom: 16px; color: #888; font-size: 13px;">Cualquier persona con este enlace puede ver el proyecto en tiempo real (solo lectura).</p>
            <div class="form-group">
                <label for="share-url">Enlace para compartir</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="share-url" readonly style="flex:1;">
                    <button id="btn-copiar-link" class="btn btn-primary">Copiar</button>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" id="btn-cerrar-compartir">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="lib/fabric.min.js"></script>
    <script src="lib/sql-wasm.js"></script>
    <script src="lib/xlsx.min.js"></script>
    <script src="js/project-manager.js"></script>
    <script src="js/database.js"></script>
    <script src="js/canvas-manager.js"></script>
    <script src="js/lote-manager.js"></script>
    <script src="js/tooltip-manager.js"></script>
    <script src="js/export-manager.js"></script>
    <script src="js/datos-iniciales.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
